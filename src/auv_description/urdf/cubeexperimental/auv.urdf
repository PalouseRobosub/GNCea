<?xml version="1.0"?>
<robot name="auv" xmlns:xacro="http://ros.org/wiki/xacro">

  <!-- Global defaults (override via command line or launch) -->
  <xacro:property name="cube_size_x" value="0.5"/>
  <xacro:property name="cube_size_y" value="0.5"/>
  <xacro:property name="cube_size_z" value="0.5"/>
  <xacro:property name="cube_mass"   value="989.9"/>

  <!-- Camera parameters -->
  <xacro:property name="cam_box"        value="0.1 0.1 0.1"/>   <!-- visual box for camera_link -->
  <xacro:property name="cam_mount_xyz"  value="0.275 0 0"/>      <!-- front of 1m cube (+x) -->
  <xacro:property name="cam_mount_rpy"  value="0 0 0"/>
  <xacro:property name="cam_fov"        value="1.047"/>         <!-- ~60 deg -->
  <xacro:property name="cam_img_w"      value="640"/>
  <xacro:property name="cam_img_h"      value="480"/>
  <xacro:property name="cam_topic"      value="/cube/image_raw"/>
  <xacro:property name="cam_update_hz"  value="30"/>
  <xacro:property name="cam_visualize"  value="true"/>

  <!-- Plugins -->
  <xacro:property name="buoyancy_link"            value="cube_link"/>
  <xacro:property name="buoyancy_water_level"     value="0.0"/>
  <xacro:property name="buoyancy_fluid_density"   value="1000.0"/>
  <xacro:property name="buoyancy_volume"          value="1.0"/>
  <xacro:property name="wasd_link"                value="cube_link"/>
  <xacro:property name="wasd_topic"               value="auve1/force_body"/>

  <!-- Include modules -->
  <xacro:include filename="$(find auv_description)/urdf/cube/cube_link.xacro"/>

  <xacro:include filename="$(find auv_description)/urdf/cube/camera_module.xacro"/>
  <xacro:include filename="$(find auv_description)/urdf/cube/plugins.xacro"/>
  <xacro:include filename="$(find auv_description)/urdf/cube/lidar3d_module.xacro"/>


  <!-- Body -->
  <xacro:cube_base
    name="cube_link"
    size_x="${cube_size_x}" size_y="${cube_size_y}" size_z="${cube_size_z}"
    mass="${cube_mass}"/>

  <!-- Camera (front-mounted) -->
  <xacro:camera_module
    parent="cube_link"
    link_name="camera_link"
    optical_frame="camera_optical_frame"
    box="${cam_box}"
    mount_xyz="${cam_mount_xyz}"
    mount_rpy="${cam_mount_rpy}"
    horiz_fov="${cam_fov}"
    img_w="${cam_img_w}"
    img_h="${cam_img_h}"
    topic="${cam_topic}"
    update_rate="${cam_update_hz}"
    visualize="${cam_visualize}"/>
  
  <!-- 3D LiDAR pointing +X -->
  <!-- <xacro:lidar3d_module
  parent="cube_link"
  link_name="lidar_link"
  topic="/lidar/points"/> -->

  <!-- TORPEDO pointing +X -->
  <xacro:torpedo_plugin
    link_name="cube_link"
  />

  <!-- HYDRODYNAMICS -->
  <gazebo>
  <plugin
          filename="gz-sim-hydrodynamics-system"
          name="gz::sim::systems::Hydrodynamics">
          <link_name>cube_link</link_name>
            <xDotU>-65.7</xDotU>        <!-- Added mass in surge (kg) -->
            <yDotV>-500.0</yDotV>        <!-- Added mass in sway (kg) -->
            <zDotW>-500.0</zDotW>        <!-- Added mass in heave (kg) -->
            <kDotP>-20.0</kDotP>         <!-- Added inertia in roll (kg·m²) -->
            <mDotQ>-25.0</mDotQ>         <!-- Added inertia in pitch (kg·m²) -->
            <nDotR>-25.0</nDotR>         <!-- Added inertia in yaw (kg·m²) -->
            
            <!-- Quadratic Drag Terms -->
            <xUabsU>-250.0</xUabsU>      <!-- Surge quadratic drag (N/(m/s)²) -->
            <xU>-175.0</xU>              <!-- Surge linear drag (N/(m/s)) -->
            <yVabsV>-1000.0</yVabsV>     <!-- Sway quadratic drag (N/(m/s)²) -->
            <yV>-600.0</yV>              <!-- Sway linear drag (N/(m/s)) -->
            <zWabsW>-1000.0</zWabsW>     <!-- Heave quadratic drag (N/(m/s)²) -->
            <zW>-600.0</zW>              <!-- Heave linear drag (N/(m/s)) -->
            <kPabsP>-15.0</kPabsP>       <!-- Roll quadratic drag (N·m/(rad/s)²) -->
            <kP>-5.0</kP>                <!-- Roll linear drag (N·m/(rad/s)) -->
            <mQabsQ>-65.0</mQabsQ>       <!-- Pitch quadratic drag (N·m/(rad/s)²) -->
            <mQ>-10.0</mQ>               <!-- Pitch linear drag (N·m/(rad/s)) -->
            <nRabsR>-65.0</nRabsR>       <!-- Yaw quadratic drag (N·m/(rad/s)²) -->
            <nR>-10.0</nR>               <!-- Yaw linear drag (N·m/(rad/s)) -->
        </plugin>
  </gazebo>






  <!-- Plugins (buoyancy + WASD) -->
  <xacro:buoyancy_plugin
    link_name="${buoyancy_link}"
    water_level="${buoyancy_water_level}"
    fluid_density="${buoyancy_fluid_density}"
    volume="${buoyancy_volume}"/>

  <xacro:wasd_plugin
    link_name="${wasd_link}"
    topic="${wasd_topic}"/>

  <!-- Spawn pose below water -->
  <gazebo reference="cube_link">
    <pose>0 0 -0.5 0 0 0</pose>
  </gazebo>

  <gazebo reference="cube_link">
    <sensor name="imu_sensor" type="imu">
      <always_on>true</always_on>
      <update_rate>100</update_rate>
      <pose>0 0 0 0 0 0</pose>
      <imu>
        <angular_velocity>
          <x>
            <noise type="gaussian">
              <mean>0</mean>
              <stddev>0.002</stddev>
            </noise>
          </x>
          <y>
            <noise type="gaussian"><mean>0</mean><stddev>0.002</stddev></noise>
          </y>
          <z>
            <noise type="gaussian"><mean>0</mean><stddev>0.002</stddev></noise>
          </z>
        </angular_velocity>
        <linear_acceleration>
          <x>
            <noise type="gaussian">
              <mean>0</mean>
              <stddev>0.05</stddev>
            </noise>
          </x>
          <y>
            <noise type="gaussian"><mean>0</mean><stddev>0.05</stddev></noise>
          </y>
          <z>
            <noise type="gaussian"><mean>0</mean><stddev>0.05</stddev></noise>
          </z>
        </linear_acceleration>
      </imu>
      <topic>/imu</topic>
    </sensor>


    <sensor name="altimeter_sensor" type="altimeter">
        <always_on>true</always_on>
        <update_rate>50</update_rate>
        <pose>0 0 0 0 0 0</pose>
        <altimeter>
          <vertical_position>
            <noise type="gaussian">
              <mean>0.0</mean>
              <stddev>0.01</stddev>            <!-- meters -->
              <bias_mean>0.0</bias_mean>
              <bias_stddev>0.001</bias_stddev>
            </noise>
          </vertical_position>

          <vertical_velocity>
            <noise type="gaussian">
              <mean>0.0</mean>
              <stddev>0.02</stddev>            <!-- m/s -->
              <bias_mean>0.0</bias_mean>
              <bias_stddev>0.001</bias_stddev>
            </noise>
          </vertical_velocity>
        </altimeter>
        <topic>/altimeter</topic>
      </sensor>    
  </gazebo>
</robot>
